<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>English 3 Speaking Milestone 3</title>

  <!-- ثبّت المسارات على GitHub Pages -->
  <base href="/lastone/">

  <!-- مكتبات من CDN (تجنّب المسارات المحلية) -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <style>
    .promptHolder{
      background:#f7f7f7; border:2px solid #EBEBEB; color:#468283;
      font-size:calc(1.75vw + 1.75vh); width:90%; border-radius:10px; margin:auto;
      font-family:'Trebuchet MS','Lucida Sans Unicode','Lucida Grande','Lucida Sans',Arial,sans-serif;
      justify-content:center; align-items:center; padding:1em;
    }
    #pageHead{ color:#468283; font-family:'Trebuchet MS','Lucida Sans Unicode','Lucida Grande','Lucida Sans',Arial,sans-serif }
    #cont{ text-align:center; height:95vh; width:95vw; overflow:auto; margin:auto; }
    #overlay{
      position:fixed; inset:0; background-color:rgba(255,255,255,.7);
      display:flex; justify-content:center; align-items:center; z-index:1000;
    }
    .butt{
      background:#84BD00; color:#fff; border-radius:6px; width:100px; left:50%;
      transform:translateX(-50%) translateZ(0); padding:10px; text-align:center;
      font-family:'Trebuchet MS','Lucida Sans Unicode','Lucida Grande','Lucida Sans',Arial,sans-serif;
      font-size:1.5em; box-shadow:0 2px 5px rgba(0,0,0,.3); position:fixed; bottom:20px; cursor:pointer;
    }
    .butt:active{ transform:translateX(-50%) translateZ(0) scale(.96); box-shadow:0 2px 4px rgba(0,0,0,.3); }
    .pCount{ width:93vw; text-align:center; font-family:'Trebuchet MS','Lucida Sans Unicode','Lucida Grande','Lucida Sans',Arial,sans-serif; }
    #image_holder{ width:90%; justify-content:center; cursor:pointer; display:none; margin:auto; overflow:visible; }
    #promptPic{ display:block; margin:10px auto; max-width:250px; max-height:150px; box-shadow:0 2px 2px rgba(0,0,0,.3); cursor:pointer; }
    .zoom{ position:fixed; inset:0; background:#fffEE; z-index:999; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:1rem; }
    @media (max-width:750px){ .promptHolder{ font-size:2em; width:85%; } .pCount{ width:85%; padding-left:5rem; } }
    @media (max-width:500px){ .pCount{ padding-left:3rem; } #promptPic{ max-width:150px; } }

    /* iPad تحسين لمس + ارفع الأزرار فوق أي طبقات */
    *{ -webkit-tap-highlight-color:transparent; touch-action:manipulation; }
    #overlay{ display:none !important; pointer-events:none !important; z-index:-1 !important; }
    #butt,#butt1,#butt2,#butt3{ position:relative; z-index:2147483647; pointer-events:auto !important; }
  </style>
</head>

<body>
  <!-- overlay -->
  <div id="overlay"><img src="loading.gif" alt="Loading" id="loading-image" /></div>

  <div id="cont">
    <h1 id="pageHead" style="display:none;">English 3 Speaking Milestone 3</h1>

    <div id="pCount" class="pCount">
      <div style="margin-left:auto;margin-right:0;margin-bottom:5px;width:75px;padding:5px;border-radius:7px;">
        <span id="pno" style="font-size:1.25em"></span><span id="pto"></span>
      </div>
    </div>

    <div class="promptHolder" id="promptHolder">
      <h2 class="iHead" style="font-size:2rem;margin:0 0 1.5rem 0">English 3 Speaking Milestone 3</h2>
      <div class="iText" style="font-size:1.5rem;font-weight:500;margin-top:.5rem">
        <span style="font-weight:bold">This assessment covers these functions:</span>
      </div>
      <div class="iText" style="display:flex;justify-content:center;margin-left:auto;font-size:1.5rem;">
        <ul style="text-align:left;">
          <li>Talking about rules</li>
          <li>Making, accepting, and refusing offers</li>
          <li>Talking about willingness</li>
          <li>Inviting and handling questions</li>
          <li>Asking for, offering, and providing clarification</li>
          <li>Talking about requirements</li>
          <li>Talking about mistakes</li>
          <li>Talking about abbreviations</li>
          <li>Assigning tasks</li>
          <li>Talking about responsibilities</li>
          <li>Talking about purpose and function</li>
          <li>Talking about range and duration</li>
        </ul>
      </div>
    </div>

    <div id="image_holder" style="display:none">
      <span id="closeX"
        style="text-align:center; position:absolute; right:2%; top:2%; font-family:arial; font-weight:bold; display:none; background:black; border-radius:20px; padding:5px; width:20px; color:white;">
        X
      </span>
      <img id="promptPic" src="" alt="" />
      <p id="cap" style="text-align:center; font-family:'Trebuchet MS'">Tap to enlarge</p>
    </div>

    <div style="margin-top:2em">
      <div class="butt" id="butt">Continue</div>
      <div class="butt" id="butt1" style="display:none;">OK</div>
      <div class="butt" id="butt2" style="display:none;">Start</div>
      <div class="butt" id="butt3" style="display:none;">Restart</div>
    </div>
  </div>

  <!-- أصوات الواجهة (اختياري) -->
  <script>
    window.endBlurb = new Audio("E3_E4_End.mp3");
    window.badge    = new Audio("E3_SM3_Intro.mp3");
    window.instr    = new Audio("E3_4_SM3_Inst.mp3");
  </script>

  <script>
  (function(){
    /* ========== 0) بيانات ثابتة (12 سؤال محليًا) ========== */
    const PROMPTS = [
      { text: "You are scheduling a meeting. Talk about its duration.",                   audio: "g1.mp3",  image: "1.png"  },
      { text: "You are planning a workshop. Talk about its duration.",                    audio: "g2.mp3",  image: "2.png"  },
      { text: "You repaired a pump. Talk about the duration of the repair work.",         audio: "g3.mp3",  image: "3.png"  },
      { text: "Ask Ahmed about the duration of the meeting.",                             audio: "g4.mp3",  image: ""       },
      { text: "Ask Noora about the duration of her shift.",                               audio: "g5.mp3",  image: ""       },
      { text: "Kamal started in 2020. Talk about duration.",                              audio: "g6.mp3",  image: ""       },
      { text: "You have a leadership course. Talk about its duration.",                   audio: "g7.mp3",  image: "7.png"  },
      { text: "You are organizing a safety inspection. Talk about its duration.",         audio: "g8.mp3",  image: "8.png"  },
      { text: "You completed maintenance work. Talk about its duration.",                 audio: "g9.mp3",  image: "9.png"  },
      { text: "Sara took a break. Talk about its duration.",                              audio: "g10.mp3", image: "10.png" },
      { text: "State a worksite rule and explain it.",                                    audio: "",        image: ""       },
      { text: "Make an offer to help a co-worker and accept/refuse properly.",            audio: "",        image: ""       }
    ];

    /* ========== 1) حالة عامة ========== */
    let index = -1; // سيصبح 0 عند أول ضغط Start
    const total = PROMPTS.length;
    const pageHead = document.getElementById('pageHead');
    const promptHolder = document.getElementById('promptHolder');
    const pno = document.getElementById('pno');
    const pto = document.getElementById('pto');
    const pCount = document.getElementById('pCount');
    const nextBtn = document.getElementById('butt2');
    const contBtn = document.getElementById('butt');
    const okBtn   = document.getElementById('butt1');
    const rstBtn  = document.getElementById('butt3');
    const imgHolder = document.getElementById('image_holder');
    const promptPic = document.getElementById('promptPic');
    const cap = document.getElementById('cap');
    const overlay = document.getElementById('overlay');

    // عداد أعلى يمين
    if (pto) pto.textContent = String(total);

    // قناة صوت واحدة
    const single = new Audio();
    single.preload = 'auto';
    single.playsInline = true;

    function showNext(){ if(nextBtn){ nextBtn.style.display = 'block'; } }
    function hideNext(){ if(nextBtn){ nextBtn.style.display = 'none'; } }

    // افتح الصوت على iOS بأول لمسة
    function unlockAudioOnce(){
      try{
        const a = new Audio(); a.muted = true; a.src = 'E3_SM3_Intro.mp3';
        a.play().then(()=>{ a.pause(); a.src=''; }).catch(()=>{});
      }catch(_){}
      document.removeEventListener('touchend', unlockAudioOnce, true);
    }
    document.addEventListener('touchend', unlockAudioOnce, true);

    // failsafe: اخفِ overlay بعد 8 ثواني
    function hideOverlay(){
      if(!overlay) return;
      overlay.style.display='none'; overlay.style.pointerEvents='none'; overlay.style.zIndex='-1';
    }
    window.addEventListener('load', hideOverlay, {once:true});
    setTimeout(hideOverlay, 8000);

    // عرض السؤال i
    function render(i){
      const it = PROMPTS[i] || {};
      if (pCount) pCount.style.display = 'block';
      if (promptHolder) promptHolder.textContent = it.text || '';
      if (pno) pno.textContent = (String(i+1) + ' / ');

      if (it.image){
        imgHolder.style.display = 'block';
        promptPic.src = it.image;
      } else {
        imgHolder.style.display = 'none';
        promptPic.src = '';
      }

      // شغّل الصوت المتوافق
      hideNext();
      try{ single.pause(); single.currentTime = 0; }catch(_){}
      const src = it.audio || '';
      if (src){
        single.src = src;
        const p = single.play(); if(p && p.catch) p.catch(()=>{});
      } else {
        // بلا صوت → أظهر Next فورًا
        showNext();
      }
    }

    single.onended = showNext;

    // تكبير/تصغير الصورة
    promptPic.addEventListener('pointerup', function(){
      imgHolder.classList.add('zoom');
      promptPic.style.maxWidth = '80vw';
      promptPic.style.maxHeight = '75vh';
      cap.textContent = promptHolder.textContent || 'Tap to close';
      cap.style.fontSize = '1.25rem';
      cap.style.background = 'white';
      document.getElementById('closeX').style.display = 'block';
    });
    document.getElementById('closeX').addEventListener('pointerup', function(){
      imgHolder.classList.remove('zoom');
      promptPic.style.maxWidth = '250px';
      promptPic.style.maxHeight = '150px';
      cap.textContent = 'Tap to enlarge';
      cap.style.fontSize = '1rem';
      this.style.display = 'none';
    });

    // أزرار: اربط pointerup فقط (لا onclick/ click/ touchend) + منع الدبل
    function bindOnce(btn, fn){
      if(!btn || typeof fn !== 'function') return;
      const clean = btn.cloneNode(true);
      btn.parentNode.replaceChild(clean, btn);
      let busy = false;
      clean.addEventListener('pointerup', function(e){
        e.preventDefault(); e.stopPropagation();
        if(busy) return; busy = true; setTimeout(()=>busy=false, 250);
        fn();
      }, {passive:false});
      clean.style.pointerEvents='auto'; clean.style.cursor='pointer';
    }

    bindOnce(contBtn, function(){
      if (contBtn) contBtn.style.display='none';
      if (okBtn) okBtn.style.display='block';
      try{ badge && badge.play && badge.play(); }catch(_){}
    });

    bindOnce(okBtn, function(){
      try{ badge && badge.pause && badge.pause(); }catch(_){}
      if (okBtn) okBtn.style.display='none';
      if (nextBtn){ nextBtn.textContent='Start'; nextBtn.style.display='block'; }
      try{
        instr && instr.currentTime !== undefined && (instr.currentTime = 0);
        instr && instr.play && instr.play();
      }catch(_){}
    });

    bindOnce(nextBtn, function(){
      try{ instr && instr.pause && instr.pause(); }catch(_){}
      if (pageHead) pageHead.style.display='block';
      if (nextBtn) nextBtn.textContent='Next';

      index++;
      if (index >= total){
        if (promptHolder) promptHolder.textContent = 'You have finished.';
        if (pCount) pCount.style.display='none';
        if (nextBtn) nextBtn.style.display='none';
        if (rstBtn) rstBtn.style.display='block';
        try{ endBlurb && endBlurb.play && endBlurb.play(); }catch(_){}
        return;
      }
      render(index);
    });

    bindOnce(rstBtn, function(){ location.reload(); });
  })();
  </script>
</body>
</html>
